@page "/searchdriver"
@inject IHttpClientFactory _clientFactory

<h3>Search for a Driver</h3>
<input @bind="Name" type="text" @oninput="@(( args ) =>Name = args.Value.ToString())"/>
<input type="text" value="@Name" @oninput="@Search" />
@if (drivers == null)
{
    <h4>Search for a driver</h4>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Code</th>
                <th>Name</th>
                <th>Last Name</th>
                <th>Nationality</th>
                <th>Born</th>
                <th>Info</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var driver in FilteredDrivers)
            {
                <tr>
                    <td>@driver.Code</td>
                    <td>@driver.GivenName</td>
                    <td>@driver.FamilyName</td>
                    <td>@driver.Nationality</td>
                    <td>@driver.DateOfBirth</td>
                    <td><a href="@driver.Url">Wiki</a></td>
                </tr>
            }
        </tbody>
    </table>
}
@code {
    private string SearchValue { get; set; }

    public IEnumerable<Driver> sortedDrivers = new List<Driver>();
    public List<Driver> unsortedDrivers = new List<Driver>();
    public Driver[] drivers;
    private FetchedData fetchedData;
    public string Name { get; set; } = "";
    public List<Driver> driverlist = new List<Driver>();

    List<Driver> FilteredDrivers => unsortedDrivers.Where(i => i.GivenName.ToLower().Contains(Name.ToLower())).ToList();

    protected override async Task OnInitializedAsync()
    {
        drivers = null;
        var Http = _clientFactory.CreateClient("ErgastClient");
        fetchedData = await Http.GetFromJsonAsync<FetchedData>($"api/f1/drivers.json?limit=1000");
        drivers = fetchedData.MRData.DriverTable.Drivers;

        driverlist = null;
        unsortedDrivers = null;

        foreach (Driver driver in drivers)
        {
            driverlist.Add(driver);
            unsortedDrivers.Add(driver);
        }
    }

    public void Search(ChangeEventArgs args)
    {
        //sortedDrivers = driverlist.OrderByDescending(driver => driver.GivenName);
        sortedDrivers = driverlist.Where(i => i.GivenName.Contains(args.Value.ToString()));

    }

    public class FetchedData
    {
        public MrData MRData { get; set; }
    }

    public class MrData
    {
        public string Xmlns { get; set; }
        public string Series { get; set; }
        public string Url { get; set; }
        public string Limit { get; set; }
        public string Offset { get; set; }
        public string Total { get; set; }
        public DriverTable DriverTable { get; set; }
    }

    public class DriverTable
    {
        public string Season { get; set; }
        public Driver[] Drivers { get; set; }
    }

    public class Driver
    {
        public string DriverId { get; set; }
        public string Code { get; set; }
        public string Url { get; set; }
        public string GivenName { get; set; }
        public string FamilyName { get; set; }
        public DateTimeOffset DateOfBirth { get; set; }
        public string Nationality { get; set; }
        public int PermanentNumber { get; set; }
    }
}
